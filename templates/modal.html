{% load static %}
<!-- Overlay -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden"></div>

<!-- Modal Form (Create/Update) -->
<div id="product-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-y-auto">
    <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 id="modal-title" class="text-xl font-bold mb-4">Add Product</h2>
    <form id="product-form" class="space-y-4">
      <input type="hidden" id="product-id" name="product_id" />
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input type="text" id="product-name" name="name" class="w-full border rounded px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Price ($)</label>
        <input type="number" id="product-price" name="price" class="w-full border rounded px-3 py-2" required min="0" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Brand</label>
        <input type="text" id="product-brand" name="brand" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select id="product-category" name="category" class="w-full border rounded px-3 py-2" required>
          <option value="">Select category</option>
          <option value="shoes">Shoes</option>
          <option value="ball">Ball</option>
          <option value="jersey">Jersey</option>
          <option value="shorts">Shorts</option>
          <option value="accessories">Accessories</option>
          <option value="equipment">Equipment</option>
          <option value="training gear">Training Gear</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Stock</label>
        <input type="number" id="product-stock" name="stock" class="w-full border rounded px-3 py-2" required min="0" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Thumbnail URL</label>
        <input type="url" id="product-thumbnail" name="thumbnail" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description</label>
        <textarea id="product-description" name="description" class="w-full border rounded px-3 py-2"></textarea>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="product-featured" name="is_featured" class="mr-2" />
        <label for="product-featured" class="text-sm">Featured</label>
      </div>
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition-colors font-semibold">
        <span id="modal-submit-text">Add Product</span>
      </button>
    </form>
  </div>
</div>

<!-- Modal Delete Confirmation -->
<div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
    <button id="delete-modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-xl font-bold mb-4 text-red-600">Delete Product</h2>
    <p class="mb-6">Are you sure you want to delete <span id="delete-product-name" class="font-semibold"></span>?</p>
    <div class="flex justify-end gap-2">
      <button id="delete-cancel-btn" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
      <button id="delete-confirm-btn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<!-- Tombol Add Product & Refresh -->
<div class="fixed bottom-8 left-8 z-40 flex flex-col gap-3">
  <button id="open-create-modal-btn" class="bg-green-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-green-700 font-bold flex items-center gap-2">
    <span>+</span> Add Product
  </button>
  <button id="refresh-products-btn" class="bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-700 font-bold flex items-center gap-2">
    <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582M20 20v-5h-.581M5.635 19.364A9 9 0 104.582 9.582" /></svg>
    Refresh
  </button>
</div>

<script>
const modalOverlay = document.getElementById('modal-overlay');
const productModal = document.getElementById('product-modal');
const productForm = document.getElementById('product-form');
const modalTitle = document.getElementById('modal-title');
const modalSubmitText = document.getElementById('modal-submit-text');
const modalCloseBtn = document.getElementById('modal-close-btn');
const openCreateModalBtn = document.getElementById('open-create-modal-btn');
const refreshProductsBtn = document.getElementById('refresh-products-btn');

const deleteModal = document.getElementById('delete-modal');
const deleteProductName = document.getElementById('delete-product-name');
const deleteModalCloseBtn = document.getElementById('delete-modal-close-btn');
const deleteCancelBtn = document.getElementById('delete-cancel-btn');
const deleteConfirmBtn = document.getElementById('delete-confirm-btn');

let editingProductId = null;
let deletingProductId = null;

// Show/hide modal helpers
function openModal() {
  modalOverlay.classList.remove('hidden');
  productModal.classList.remove('hidden');
}
function closeModal() {
  modalOverlay.classList.add('hidden');
  productModal.classList.add('hidden');
  productForm.reset();
  editingProductId = null;
  modalTitle.textContent = 'Add Product';
  modalSubmitText.textContent = 'Add Product';
}
function openDeleteModal(productId, productName) {
  deletingProductId = productId;
  deleteProductName.textContent = productName;
  modalOverlay.classList.remove('hidden');
  deleteModal.classList.remove('hidden');
}
function closeDeleteModal() {
  deletingProductId = null;
  modalOverlay.classList.add('hidden');
  deleteModal.classList.add('hidden');
}

// Open create modal
openCreateModalBtn.addEventListener('click', () => {
  closeDeleteModal();
  closeModal();
  modalTitle.textContent = 'Add Product';
  modalSubmitText.textContent = 'Add Product';
  productForm.reset();
  document.getElementById('product-brand').value = "No Brand";
  openModal();
});

// Close modal
modalCloseBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', () => {
  closeModal();
  closeDeleteModal();
});

// Refresh products
refreshProductsBtn.addEventListener('click', () => {
  if (typeof fetchProductsFromServer === 'function') fetchProductsFromServer();
  showToast({title: "Refreshed", message: "Product list updated!", type: "info"});
});

// Handle form submit (create/update)
productForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(productForm);
  const data = {};
  formData.forEach((value, key) => {
    if (key === "is_featured") data[key] = productForm.is_featured.checked;
    else data[key] = value;
  });

  let url = '/create-product-ajax/';
  let method = 'POST';
  let successMsg = 'Product created successfully!';
  if (editingProductId) {
    url = `/edit-product-ajax/${editingProductId}/`;
    method = 'POST';
    successMsg = 'Product updated successfully!';
  }

  try {
    const response = await fetch(url, {
      method: method,
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(data),
    });
    const result = await response.json();
    if (response.ok) {
      showToast({title: "Success", message: successMsg, type: "success"});
      closeModal();
      if (typeof fetchProductsFromServer === 'function') fetchProductsFromServer();
    } else {
      showToast({title: "Error", message: result.error || "Failed to save product", type: "error"});
    }
  } catch (err) {
    showToast({title: "Error", message: "Network error", type: "error"});
  }
});

// Edit product (dipanggil dari JS utama)
window.openEditProductModal = function(product) {
  closeDeleteModal();
  openModal();
  editingProductId = product.id;
  modalTitle.textContent = 'Edit Product';
  modalSubmitText.textContent = 'Update Product';
  document.getElementById('product-id').value = product.id;
  document.getElementById('product-name').value = product.name;
  document.getElementById('product-price').value = product.price;
  document.getElementById('product-brand').value = product.brand;
  document.getElementById('product-category').value = product.category;
  document.getElementById('product-stock').value = product.stock;
  document.getElementById('product-thumbnail').value = product.thumbnail;
  document.getElementById('product-description').value = product.description;
  document.getElementById('product-featured').checked = !!product.is_featured;
};

// Delete modal events
deleteModalCloseBtn.addEventListener('click', closeDeleteModal);
deleteCancelBtn.addEventListener('click', closeDeleteModal);
deleteConfirmBtn.addEventListener('click', async function() {
  if (!deletingProductId) return;
  try {
    const response = await fetch(`/delete-product-ajax/${deletingProductId}/`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
    });
    const result = await response.json();
    if (response.ok) {
      showToast({title: "Deleted", message: "Product deleted successfully!", type: "success"});
      closeDeleteModal();
      if (typeof fetchProductsFromServer === 'function') fetchProductsFromServer();
    } else {
      showToast({title: "Error", message: result.error || "Failed to delete product", type: "error"});
    }
  } catch (err) {
    showToast({title: "Error", message: "Network error", type: "error"});
  }
});

// Untuk trigger modal edit/delete dari JS utama
window.openDeleteProductModal = openDeleteModal;
</script>