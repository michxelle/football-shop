{% extends 'base.html' %}
{% load static %}

{% block meta %}
    <title>Footballed Co.</title>
{% endblock meta %}

{% block content %}
<div class="bg-[#fffffc] w-full pt-12 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Football Products</h1>
                <p class="text-gray-600">Shop your favorite football products here!</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex space-x-3 mb-4 sm:mb-0">
                <a href="#" id="filter-all" class="filter-btn active-filter">All Products</a>
                <a href="#" id="filter-user" class="filter-btn">My Products</a>
            </div>
            {% if user.is_authenticated %}
                <div class="text-sm text-gray-500">
                    Last login: {{ last_login }}
                </div>
            {% endif %}
        </div>

        <!-- Loading State -->
        <div id="loading-container" class="hidden flex flex-col items-center justify-center py-16">
            <svg class="animate-spin h-10 w-10 text-green-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
            <span class="text-gray-600 font-medium">Loading products...</span>
        </div>

        <!-- Error State -->
        <div id="error-container" class="hidden flex flex-col items-center justify-center py-16">
            <svg class="h-10 w-10 text-red-500 mb-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            <h3 class="text-lg font-semibold text-red-600 mb-2">Failed to load products</h3>
            <p class="text-gray-500 mb-4">There was a problem fetching the product data. Please try again.</p>
            <button id="retry-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Retry</button>
        </div>

        <!-- Empty State -->
        <div id="empty-container" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
            <div class="w-32 h-32 mx-auto mb-4">
                <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
            <p class="text-gray-500 mb-6">Sorry, there are no products available at the moment.</p>
            <a href="#" id="add-product-btn" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                Add Product
            </a>
        </div>

        <!-- Product Grid -->
        <div id="grid-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Product cards will be injected here by JS -->
        </div>
    </div>
</div>

<script>
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// DOM Elements
const loadingContainer = document.getElementById('loading-container');
const errorContainer = document.getElementById('error-container');
const emptyContainer = document.getElementById('empty-container');
const productGridContainer = document.getElementById('grid-container');
const showAllBtn = document.getElementById('filter-all');
const showUserBtn = document.getElementById('filter-user');

// State
let activeFilter = 'all';
let allProductData = [];

// Update filter button appearance
function updateFilterButtonsAppearance() {
  if (!showAllBtn || !showUserBtn) return;
  if (activeFilter === 'all') {
    showAllBtn.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showUserBtn.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-gray-100';
  } else {
    showUserBtn.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showAllBtn.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-gray-100';
  }
}

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingContainer.classList.toggle('hidden', !showLoading);
  errorContainer.classList.toggle('hidden', !showError);
  emptyContainer.classList.toggle('hidden', !showEmpty);
  productGridContainer.classList.toggle('hidden', !showGrid);
  if (showGrid) {
    productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

// Get readable category name
function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    shoes: 'Shoes',
    ball: 'Ball',
    jersey: 'Jersey',
    shorts: 'Shorts',
    accessories: 'Accessories',
    equipment: 'Equipment',
    'training gear': 'Training Gear',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

// Create product card element
function buildProductCardElement(product) {
  const articleElement = document.createElement('article');
  articleElement.className = 'bg-white rounded-2xl border border-gray-200 hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col';

  const detailLink = "{% url 'main:show_product' '000' %}".replace('000', product.id);
  const editLink = "{% url 'main:edit_product' '000' %}".replace('000', product.id);
  const deleteLink = "{% url 'main:delete_product' '000' %}".replace('000', product.id);

  const thumbnailHtml = product.thumbnail
    ? `<img src="${product.thumbnail}" alt="${product.name}" class="w-full h-full object-cover rounded-t-2xl">`
    : `<img src="{% static 'image/no-image.png' %}" alt="No image" class="w-full h-full object-contain opacity-60 rounded-t-2xl">`;

  const featuredBadge = product.is_featured
    ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-400 text-yellow-900 shadow">â˜… Featured</span>`
    : '';
  const outOfStockBadge = product.stock == 0
    ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-500 text-white shadow">Out of Stock</span>`
    : '';

  const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(product.user_id)
    ? `<div class="flex space-x-2">
        <button type="button"
            class="text-gray-600 hover:text-gray-900 text-sm font-semibold transition-colors"
            onclick='openEditProductModal(${JSON.stringify(product)})'>
            Edit
        </button>
        <button type="button"
            class="text-red-600 hover:text-red-800 text-sm font-semibold transition-colors"
            onclick='openDeleteProductModal("${product.id}", "${product.name}")'>
            Delete
        </button>
        </div>`
    : '';

  const formattedPrice = Number(product.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  articleElement.innerHTML = `
    <div class="relative aspect-[4/3] bg-gradient-to-br from-green-50 to-blue-50 overflow-hidden">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white shadow">
          ${getReadableCategoryName(product.category)}
        </span>
      </div>
      <div class="absolute top-3 right-3 flex flex-col gap-2 items-end">
        ${featuredBadge}
        ${outOfStockBadge}
      </div>
    </div>
    <div class="flex-1 flex flex-col p-5">
      <h3 class="text-xl font-extrabold text-gray-900 mb-1 leading-tight">
        <a href="${detailLink}" class="hover:text-green-600 transition-colors">
          ${product.name}
        </a>
      </h3>
      <div class="flex items-center text-sm text-gray-500 mb-2">
        <span class="font-medium text-gray-700">Brand:</span>
        <span class="ml-1 font-semibold text-green-700">${product.brand}</span>
      </div>
      <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description}</p>
      <div class="mb-4">
        <span class="text-2xl font-black text-green-600 drop-shadow-sm">$${formattedPrice}</span>
      </div>
      <div class="mt-auto pt-4 border-t border-gray-100 flex items-center justify-between">
        <a href="${detailLink}" class="text-green-700 hover:text-green-900 font-bold text-base transition-colors">
          View Details
        </a>
        ${editDeleteButtons}
      </div>
    </div>
  `;
  return articleElement;
}

// Render all product cards
function renderAllProductCards(products) {
  productGridContainer.innerHTML = '';
  products.forEach(product => {
    const cardElement = buildProductCardElement(product);
    productGridContainer.appendChild(cardElement);
  });
}

// Filter and display products
function filterAndDisplayProducts() {
  updateFilterButtonsAppearance();
  const filteredProducts = activeFilter === 'all'
    ? allProductData
    : allProductData.filter(product => Number(product.user_id) === Number(CURRENT_USER_ID));
  if (filteredProducts.length === 0) {
    displayPageSection({ showEmpty: true });
  } else {
    renderAllProductCards(filteredProducts);
    displayPageSection({ showGrid: true });
  }
}

// Fetch product data from server
async function fetchProductsFromServer() {
  try {
    displayPageSection({ showLoading: true });
    const response = await fetch(PRODUCT_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });
    if (!response.ok) throw new Error('Failed to fetch product data from server');
    const productData = await response.json();
    allProductData = productData || [];
    filterAndDisplayProducts();
  } catch (error) {
    console.error('Error loading products:', error);
    displayPageSection({ showError: true });
  }
}

// Event handlers
function handleShowAllClick(e) {
  e.preventDefault();
  activeFilter = 'all';
  filterAndDisplayProducts();
}
function handleShowUserClick(e) {
  e.preventDefault();
  activeFilter = 'user';
  filterAndDisplayProducts();
}

// Initialize page
function initializeProductPage() {
  if (showAllBtn) showAllBtn.addEventListener('click', handleShowAllClick);
  if (showUserBtn) showUserBtn.addEventListener('click', handleShowUserClick);
  fetchProductsFromServer();
}

// Start application
initializeProductPage();

// Add Product button in empty state
const addProductBtn = document.getElementById('add-product-btn');
if (addProductBtn) {
  addProductBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (typeof openCreateModalBtn !== 'undefined') {
      openCreateModalBtn.click();
    } else {
      // Fallback: open modal manually if openCreateModalBtn is not available
      if (typeof openModal === 'function') openModal();
    }
  });
}
</script>
{% endblock content %}